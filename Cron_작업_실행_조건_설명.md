# Cron 작업 실행 조건 설명

## 📋 현재 설정된 Cron Job

```bash
#Ansible: Daily Server Check System
0 9 * * * /home/sth0824/run_daily_check.sh

# API 서버 자동 업데이트 (5분마다 체크)
*/5 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh >> /tmp/api_auto_update.log 2>&1
```

## 🔍 API 서버 자동 업데이트 Cron Job 실행 조건

### 1. 시간 조건 (Cron 스케줄)

```
*/5 * * * *
```

**의미:**
- `*/5`: **5분마다** 실행
- 첫 번째 `*`: 매 시간
- 두 번째 `*`: 매 일
- 세 번째 `*`: 매 월
- 네 번째 `*`: 매 요일

**실제 실행 시간:**
- 00:00, 00:05, 00:10, 00:15, 00:20, ... (5분 간격)
- 24시간 내내 5분마다 실행
- 하루에 총 **288번** 실행 (24시간 × 60분 ÷ 5분)

### 2. 스크립트 내부 조건 (실제 업데이트 여부)

스크립트가 실행되어도 **항상 업데이트하는 것은 아닙니다:**

#### ✅ 업데이트가 실행되는 조건

```bash
# 1. 원격 저장소에서 최신 정보 가져오기
git fetch origin develop

# 2. 로컬과 원격의 차이 확인
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/develop)

# 3. 차이가 있을 때만 업데이트
if [ "$LOCAL" != "$REMOTE" ]; then
    # 업데이트 실행
    git pull origin develop
    # 서버 재시작
fi
```

**즉, 다음 조건이 모두 만족될 때만 업데이트:**
1. ✅ Cron이 5분마다 실행됨 (시간 조건)
2. ✅ GitHub에 새로운 커밋이 있음 (변경사항 조건)
3. ✅ 로컬 코드와 원격 코드가 다름 (차이 조건)

#### ❌ 업데이트가 실행되지 않는 경우

1. **최신 코드인 경우**
   ```
   [2026-01-09 15:21:46] ✅ 최신 코드입니다. 업데이트 불필요.
   ```
   - 로컬과 원격이 동일하면 아무것도 하지 않음
   - 서버 재시작도 하지 않음 (효율적)

2. **Git pull 실패 시**
   - 충돌이 발생하면 업데이트 중단
   - 로그에 에러 기록

## 📊 실행 흐름도

```
5분마다 Cron 실행
    ↓
스크립트 시작
    ↓
git fetch (원격 정보만 가져옴, 파일 변경 없음)
    ↓
로컬 vs 원격 비교
    ↓
┌─────────────────┬─────────────────┐
│   차이가 있음    │   차이가 없음    │
│   (업데이트 필요)│   (최신 상태)    │
└─────────────────┴─────────────────┘
    ↓                    ↓
git pull            아무것도 안 함
    ↓                    ↓
서버 재시작         종료
    ↓
완료
```

## 🕐 실제 실행 예시

### 시나리오 1: 변경사항 없음

```
15:00:00 - Cron 실행
15:00:01 - git fetch
15:00:02 - 비교: 로컬 == 원격
15:00:02 - "✅ 최신 코드입니다. 업데이트 불필요."
15:00:02 - 종료 (서버 재시작 없음)
```

### 시나리오 2: 변경사항 있음

```
15:05:00 - Cron 실행
15:05:01 - git fetch
15:05:02 - 비교: 로컬 != 원격
15:05:02 - "📥 변경사항 발견! 업데이트 시작..."
15:05:03 - git pull
15:05:05 - "✅ 코드 업데이트 완료"
15:05:05 - 기존 서버 종료
15:05:07 - 새 서버 시작
15:05:10 - "✅ 업데이트 및 재시작 완료!"
```

## ⚙️ Cron 표현식 설명

### 기본 형식

```
분 시 일 월 요일 명령어
*  *  *  *  *
│  │  │  │  │
│  │  │  │  └─── 요일 (0-7, 0과 7은 일요일)
│  │  │  └───── 월 (1-12)
│  │  └─────── 일 (1-31)
│  └───────── 시 (0-23)
└─────────── 분 (0-59)
```

### 현재 설정 해석

```
*/5 * * * *
```

- `*/5`: 5분마다 (0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55분)
- `*`: 매 시간
- `*`: 매 일
- `*`: 매 월
- `*`: 매 요일

**결과:** 5분마다 실행

### 다른 예시

```bash
# 매일 오전 9시
0 9 * * *

# 매일 오전 9시와 오후 6시
0 9,18 * * *

# 평일(월-금) 오전 9시
0 9 * * 1-5

# 매주 월요일 오전 9시
0 9 * * 1

# 10분마다
*/10 * * * *

# 매 시간 정각
0 * * * *
```

## 🔧 실행 조건 변경 방법

### 더 자주 체크하고 싶다면

```bash
# 1분마다 체크 (권장하지 않음 - 부하 증가)
*/1 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh

# 3분마다 체크
*/3 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh
```

### 덜 자주 체크하고 싶다면

```bash
# 10분마다 체크
*/10 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh

# 30분마다 체크
*/30 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh

# 1시간마다 체크
0 * * * * cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh
```

### 특정 시간에만 체크하고 싶다면

```bash
# 평일 오전 9시부터 오후 6시까지 5분마다
*/5 9-18 * * 1-5 cd /home/sth0824/ansible && /home/sth0824/ansible/auto_update_smart.sh
```

## 📝 요약

### 실행 조건 정리

1. **시간 조건**: 5분마다 자동 실행
2. **변경사항 조건**: GitHub에 새로운 커밋이 있어야 함
3. **차이 조건**: 로컬과 원격 코드가 달라야 함

### 효율성

- ✅ 변경사항이 없으면 서버 재시작 안 함 (효율적)
- ✅ 변경사항이 있을 때만 업데이트 (스마트)
- ✅ 로그에 모든 작업 기록 (추적 가능)

### 최대 지연 시간

- 팀원이 푸시 → **최대 5분 이내** 자동 반영
- 평균적으로 **2.5분** 정도면 반영됨

---

**마지막 업데이트**: 2026년 1월 9일
