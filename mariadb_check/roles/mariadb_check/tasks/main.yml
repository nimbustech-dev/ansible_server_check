---
################################
# 1. 사전 디렉토리 구조 점검
################################
- name: Check GCLOUD directory structure
  shell: |
    if [ -d /GCLOUD ]; then
      find /GCLOUD -maxdepth 3 -type d
    else
      echo "/GCLOUD directory not present"
    fi
  register: dir_tree

################################
# 2. 파일시스템 사용률 점검
################################
# 2-1. DB엔진 파일시스템 (데이터 디렉토리)
- name: Get MariaDB datadir
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'datadir';" | awk '{print $2}'
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'datadir';" | awk '{print $2}'
    else
      echo "/var/lib/mysql"
    fi
  register: mariadb_datadir
  ignore_errors: yes
  changed_when: false

- name: Check DB engine filesystem usage (datadir)
  shell: |
    DATADIR="{{ mariadb_datadir.stdout | default('/var/lib/mysql') }}"
    df -h "$DATADIR" | tail -1
  register: db_engine_fs
  failed_when: false
  changed_when: false

# 2-2. 아카이브(데이터변경) 로그 파일시스템 (바이너리 로그)
- name: Get MariaDB log_bin_basename
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_bin_basename';" | awk '{print $2}' || mariadb --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_bin';" | awk '{if ($2=="ON") print "/var/lib/mysql"}'
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_bin_basename';" | awk '{print $2}' || mysql --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_bin';" | awk '{if ($2=="ON") print "/var/lib/mysql"}'
    else
      echo "/var/lib/mysql"
    fi
  register: mariadb_log_bin_path
  ignore_errors: yes
  changed_when: false

- name: Check archive log filesystem usage (binary log)
  shell: |
    LOG_PATH="{{ mariadb_log_bin_path.stdout | default('/var/lib/mysql') }}"
    if [ -d "$LOG_PATH" ]; then
      df -h "$LOG_PATH" | tail -1
    else
      echo "Binary log path not found: $LOG_PATH"
    fi
  register: archive_log_fs
  failed_when: false
  changed_when: false

# 2-3. DB 시스템 로그 파일시스템 (에러 로그, 슬로우 쿼리 로그)
- name: Get MariaDB log_error path
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_error';" | awk '{print $2}' || echo "/var/log/mysql/error.log"
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_error';" | awk '{print $2}' || echo "/var/log/mysql/error.log"
    else
      echo "/var/log/mysql/error.log"
    fi
  register: mariadb_log_error_path
  ignore_errors: yes
  changed_when: false

- name: Check system log filesystem usage
  shell: |
    LOG_ERROR="{{ mariadb_log_error_path.stdout | default('/var/log/mysql/error.log') }}"
    LOG_DIR=$(dirname "$LOG_ERROR")
    if [ -d "$LOG_DIR" ]; then
      df -h "$LOG_DIR" | tail -1
    else
      echo "Log directory not found: $LOG_DIR"
    fi
  register: system_log_fs
  failed_when: false
  changed_when: false

# 2-4. GCLOUD 파일시스템 (기존)
- name: Check GCLOUD filesystem usage
  shell: df -h | grep GCLOUD || echo "GCLOUD filesystem not found"
  register: gcloud_df
  failed_when: false
  changed_when: false

################################
# 3. MariaDB 서비스 상태
################################
- name: Check MariaDB service status
  systemd:
    name: mariadb
  register: mariadb_service

################################
# 4. MariaDB 리스너 점검
################################
- name: Check MariaDB listener (3306)
  shell: ss -lntp | grep 3306 || echo "3306 NOT LISTENING"
  register: mariadb_listener

################################
# 5. OS 리소스 점검
################################
# 5-1. 물리적 메모리 사용률 (상세 정보)
- name: Check memory usage
  shell: free -h
  register: mem_usage
  changed_when: false

# 5-2. 물리적 메모리 사용률 (퍼센트)
- name: Calculate memory usage percentage
  shell: |
    MEM_INFO=$(free | grep Mem)
    TOTAL=$(echo $MEM_INFO | awk '{print $2}')
    USED=$(echo $MEM_INFO | awk '{print $3}')
    PERCENT=$(awk "BEGIN {printf \"%.2f\", ($USED/$TOTAL)*100}")
    echo "${PERCENT}%"
  register: mem_usage_percent
  changed_when: false
  failed_when: false

# 5-3. 물리적 CPU 사용률 (상세 정보)
- name: Check CPU usage
  shell: top -b -n1 | head -5
  register: cpu_usage
  changed_when: false

# 5-4. 물리적 CPU 사용률 (퍼센트)
- name: Get CPU usage percentage
  shell: |
    top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}'
  register: cpu_usage_percent
  changed_when: false
  failed_when: false

# 5-5. 프로세스 개수
- name: Check OS process count
  shell: ps -ef | wc -l
  register: process_count
  changed_when: false

################################
# 6. MariaDB 내부 점검
################################
# 6-1. 공유메모리(SGA) 파라미터 - InnoDB Buffer Pool
- name: Check InnoDB buffer pool size
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'innodb_buffer_pool_size';"
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'innodb_buffer_pool_size';"
    else
      echo "N/A"
    fi
  register: innodb_bp
  ignore_errors: yes
  changed_when: false

# 6-2. 바이너리 로그 상태 (온라인 백업 가능 여부 확인용)
- name: Check binary log status
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'log_bin';"
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'log_bin';"
    else
      echo "N/A"
    fi
  register: log_bin
  ignore_errors: yes
  changed_when: false

# 6-3. 온라인 백업 가능 여부 확인
- name: Check if online backup is possible
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      LOG_BIN_STATUS=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'log_bin';" | awk '{print $2}')
      if [ "$LOG_BIN_STATUS" = "ON" ]; then
        echo "ONLINE_BACKUP_POSSIBLE"
      else
        echo "ONLINE_BACKUP_NOT_POSSIBLE (log_bin is OFF)"
      fi
    else
      echo "N/A"
    fi
  register: online_backup_possible
  ignore_errors: yes
  changed_when: false

# 6-4. 트랜잭션 로그 사이즈 (바이너리 로그 파일 크기)
- name: Get binary log files size
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      LOG_BIN_STATUS=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'log_bin';" | awk '{print $2}')
      if [ "$LOG_BIN_STATUS" = "ON" ]; then
        LOG_BIN_BASE=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'log_bin_basename';" | awk '{print $2}')
        if [ -z "$LOG_BIN_BASE" ] || [ "$LOG_BIN_BASE" = "NULL" ]; then
          DATADIR=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'datadir';" | awk '{print $2}')
          LOG_BIN_BASE="${DATADIR}/mysql-bin"
        fi
        LOG_DIR=$(dirname "$LOG_BIN_BASE")
        LOG_PREFIX=$(basename "$LOG_BIN_BASE")
        if [ -d "$LOG_DIR" ]; then
          # 바이너리 로그 파일들의 총 크기 계산
          TOTAL_SIZE=$(du -sb "$LOG_DIR"/${LOG_PREFIX}* 2>/dev/null | awk '{sum+=$1} END {print sum}')
          if [ -n "$TOTAL_SIZE" ] && [ "$TOTAL_SIZE" -gt 0 ]; then
            # 바이트를 읽기 쉬운 형식으로 변환
            if [ "$TOTAL_SIZE" -lt 1024 ]; then
              echo "${TOTAL_SIZE}B"
            elif [ "$TOTAL_SIZE" -lt 1048576 ]; then
              echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1024}")KB"
            elif [ "$TOTAL_SIZE" -lt 1073741824 ]; then
              echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1048576}")MB"
            else
              echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1073741824}")GB"
            fi
          else
            echo "0 (no binary log files)"
          fi
        else
          echo "Binary log directory not found: $LOG_DIR"
        fi
      else
        echo "Binary log is OFF"
      fi
    else
      echo "N/A"
    fi
  register: transaction_log_size
  ignore_errors: yes
  changed_when: false

# 6-5. 테이블스페이스 사용률
- name: Check tablespace usage
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "
      SELECT table_schema,
             ROUND(SUM(data_length+index_length)/1024/1024,2) MB
      FROM information_schema.tables
      GROUP BY table_schema;"
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "
      SELECT table_schema,
             ROUND(SUM(data_length+index_length)/1024/1024,2) MB
      FROM information_schema.tables
      GROUP BY table_schema;"
    else
      echo "N/A"
    fi
  register: tablespace
  ignore_errors: yes
  changed_when: false

# 6-6. 최대연결수 확인
- name: Check max_connections
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      $CLIENT_BIN --connect-timeout=5 -NBe "SHOW GLOBAL VARIABLES LIKE 'max_connections';" 2>/dev/null | awk '{print $2}' || echo "N/A"
    else
      echo "N/A"
    fi
  register: max_connections
  ignore_errors: yes
  changed_when: false

# 6-7. 활성세션수 확인
- name: Check active sessions
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      $CLIENT_BIN --connect-timeout=5 -NBe "SHOW PROCESSLIST;" 2>/dev/null | wc -l || echo "0"
    else
      echo "0"
    fi
  register: active_sessions
  ignore_errors: yes
  changed_when: false

# 6-8. DB접속상태 확인
- name: Check DB connection status
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      if $CLIENT_BIN --connect-timeout=5 -e "SELECT 1;" > /dev/null 2>&1; then
        echo "CONNECTED"
      else
        echo "DISCONNECTED"
      fi
    else
      echo "N/A"
    fi
  register: db_connection_status
  ignore_errors: yes
  changed_when: false

# 6-9. 관리프로세스 확인 (mariadbd 프로세스)
- name: Check MariaDB management process
  shell: |
    if pgrep -x mariadbd > /dev/null; then
      echo "RUNNING"
    elif pgrep -f "mysqld" > /dev/null; then
      echo "RUNNING"
    else
      echo "NOT_RUNNING"
    fi
  register: mariadb_process
  ignore_errors: yes
  changed_when: false

# 6-10. HA상태 확인 (Galera 또는 복제 상태)
- name: Check HA status
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    if [ -n "$CLIENT_BIN" ]; then
      # Galera 클러스터 상태 확인
      WSREP_STATUS=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW STATUS LIKE 'wsrep_cluster_size';" 2>/dev/null | awk '{print $2}')
      if [ -n "$WSREP_STATUS" ] && [ "$WSREP_STATUS" != "NULL" ] && [ "$WSREP_STATUS" != "" ] && [ "$WSREP_STATUS" != "Variable_name" ]; then
        WSREP_STATE=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW STATUS LIKE 'wsrep_local_state_comment';" 2>/dev/null | awk '{print $2}')
        if [ -n "$WSREP_STATE" ] && [ "$WSREP_STATE" != "Variable_name" ]; then
          echo "Galera: $WSREP_STATE (Cluster Size: $WSREP_STATUS)"
        else
          echo "Galera: Configured (Cluster Size: $WSREP_STATUS)"
        fi
      else
        # 복제 상태 확인
        REPL_STATUS=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW SLAVE STATUS\\G" 2>/dev/null | grep -i "Slave_IO_Running\|Slave_SQL_Running" | head -2)
        if [ -n "$REPL_STATUS" ] && [ "$REPL_STATUS" != "" ]; then
          echo "Replication: Configured"
        else
          echo "Standalone"
        fi
      fi
    else
      echo "N/A"
    fi
  register: ha_status
  ignore_errors: yes
  changed_when: false

################################
# 7. 설치 확인 및 경로 점검
################################
# 7-1. MariaDB 설치 확인
- name: Check MariaDB installation
  shell: |
    if command -v mysql &> /dev/null; then
      echo "INSTALLED"
    else
      echo "NOT_INSTALLED"
    fi
  register: mariadb_installation
  changed_when: false
  failed_when: false

# 7-2. MariaDB 바이너리 경로 확인 (MariaDB 전용 바이너리 우선)
- name: Get MariaDB binary path
  shell: |
    # MariaDB 전용 바이너리 우선 확인
    if command -v mariadb &> /dev/null; then
      which mariadb
    elif command -v mariadbd &> /dev/null; then
      which mariadbd
    elif command -v mysql &> /dev/null; then
      # 호환성을 위해 mysql도 확인 (MariaDB 패키지에서 제공)
      which mysql
    else
      echo "N/A"
    fi
  register: mariadb_binary_path
  changed_when: false
  failed_when: false

# 7-3. MariaDB 설치 경로 (basedir) 확인
- name: Get MariaDB base directory
  shell: |
    # 방법 1: MariaDB 클라이언트로 SHOW VARIABLES로 basedir 직접 가져오기
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    CLIENT_BIN=""
    if command -v mariadb &> /dev/null; then
      CLIENT_BIN="mariadb"
    elif command -v mysql &> /dev/null; then
      CLIENT_BIN="mysql"
    fi
    
    BASEDIR=""
    if [ -n "$CLIENT_BIN" ]; then
      BASEDIR=$($CLIENT_BIN --connect-timeout=5 -NBe "SHOW VARIABLES LIKE 'basedir';" 2>/dev/null | awk '{print $2}' || echo "")
    fi
    
    # 방법 2: basedir을 못 가져온 경우 MariaDB 바이너리 경로에서 추론
    if [ -z "$BASEDIR" ] || [ "$BASEDIR" = "." ] || [ "$BASEDIR" = "" ]; then
      # MariaDB 전용 바이너리 우선 확인
      if command -v mariadbd &> /dev/null; then
        MARIADB_BIN=$(which mariadbd)
        # /usr/sbin/mariadbd -> /usr
        BASEDIR=$(dirname $(dirname "$MARIADB_BIN"))
      elif command -v mariadb &> /dev/null; then
        MARIADB_BIN=$(which mariadb)
        # /usr/bin/mariadb -> /usr
        BASEDIR=$(dirname $(dirname "$MARIADB_BIN"))
      elif command -v mysql &> /dev/null; then
        MYSQL_BIN=$(which mysql)
        # /usr/bin/mysql -> /usr
        BASEDIR=$(dirname $(dirname "$MYSQL_BIN"))
      fi
    fi
    
    # 방법 3: 그래도 못 찾으면 일반적인 경로 확인
    if [ -z "$BASEDIR" ] || [ "$BASEDIR" = "." ] || [ "$BASEDIR" = "" ]; then
      if [ -f "/usr/bin/mariadb" ] || [ -f "/usr/sbin/mariadbd" ]; then
        BASEDIR="/usr"
      elif [ -f "/usr/local/bin/mariadb" ] || [ -f "/usr/local/sbin/mariadbd" ]; then
        BASEDIR="/usr/local"
      elif [ -f "/usr/bin/mysql" ]; then
        BASEDIR="/usr"
      else
        BASEDIR="N/A"
      fi
    fi
    
    echo "$BASEDIR"
  register: mariadb_base_dir
  ignore_errors: yes
  changed_when: false

################################
# 8. 데이터베이스 정보 점검
################################
# 8-1. 데이터베이스 목록
- name: Get database list
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW DATABASES;" | grep -v -E '^(information_schema|performance_schema|mysql|sys)$' || echo ""
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW DATABASES;" | grep -v -E '^(information_schema|performance_schema|mysql|sys)$' || echo ""
    else
      echo ""
    fi
  register: db_list
  ignore_errors: yes
  changed_when: false

# 8-2. 데이터베이스 개수
- name: Get database count
  shell: |
    # MariaDB 클라이언트 우선 사용, 없으면 mysql 호환 클라이언트 사용
    if command -v mariadb &> /dev/null; then
      mariadb --connect-timeout=5 -NBe "SHOW DATABASES;" | grep -v -E '^(information_schema|performance_schema|mysql|sys)$' | wc -l
    elif command -v mysql &> /dev/null; then
      mysql --connect-timeout=5 -NBe "SHOW DATABASES;" | grep -v -E '^(information_schema|performance_schema|mysql|sys)$' | wc -l
    else
      echo "0"
    fi
  register: db_count
  ignore_errors: yes
  changed_when: false

################################
# 9. CPU/메모리 상위 프로세스 점검
################################
# 9-1. CPU 사용률 상위 프로세스 (상위 5개)
- name: Get top CPU processes
  shell: |
    ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $3, $12}'
  register: cpu_top_processes
  changed_when: false
  failed_when: false

# 9-2. 메모리 사용률 상위 프로세스 (상위 5개)
- name: Get top memory processes
  shell: |
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $4, $12}'
  register: mem_top_processes
  changed_when: false
  failed_when: false

################################
# 10. OS 기초 체력 점검 (DB 서버 운영에 필수적인 항목)
################################
# 10-1. CPU 모델명 확인
# 중요성: DB 서버 하드웨어 스펙 확인, 성능 분석 및 용량 계획에 필요
- name: Get CPU model name
  shell: |
    lscpu | grep "Model name" | awk -F: '{print $2}' | xargs
  register: cpu_model_name
  changed_when: false
  failed_when: false

# 10-2. 메모리(Swap) 상태 점검
# 중요성: DB 서버에서 Swap 사용은 성능 저하 신호. 메모리 부족 시 Swap 사용되면 쿼리 성능 급격히 저하
- name: Check Swap status
  shell: free -h | grep Swap
  register: swap_status
  changed_when: false
  failed_when: false

# 10-3. 디스크(/) 사용률 점검
# 중요성: 루트 디스크가 가득 차면 시스템 로그, 임시 파일 생성 불가로 DB 서비스 장애 가능
- name: Check root disk usage
  shell: df -h / | awk 'NR==2 {print $5}' | tr -d '%'
  register: root_disk_usage
  changed_when: false
  failed_when: false

# 10-4. 전체 디스크 사용 현황
# 중요성: DB 데이터 디렉토리 외 다른 디스크 사용률 확인. 전체 디스크 상황 파악 필요
- name: Check all disk usage
  shell: df -h
  register: all_disk_usage
  changed_when: false
  failed_when: false

# 10-5. 외부 네트워크(Google) 통신 점검
# 중요성: DB 백업, 복제, 모니터링, 패키지 업데이트 등에 외부 네트워크 연결 필요
- name: Test external network connectivity
  shell: ping -c 2 8.8.8.8
  register: network_ping_result
  changed_when: false
  failed_when: false
  ignore_errors: yes

# 10-6. 시간 동기화(NTP) 점검
# 중요성: DB 서버 시간 불일치는 트랜잭션 로그 순서, 복제 동기화, 백업 일관성에 심각한 문제 발생
- name: Check NTP synchronization
  shell: chronyc sources -v 2>/dev/null || echo "NTP not configured"
  register: ntp_sync_status
  changed_when: false
  failed_when: false
  ignore_errors: yes

################################
# 11. 보고서 생성
################################
- name: Generate MariaDB check report
  template:
    src: report.j2
    dest: /tmp/mariadb_check_report.txt

