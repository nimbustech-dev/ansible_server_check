---
################################
# 1. OS 파일시스템 사용률 점검
################################
# 1-1. DB엔진 파일시스템 (데이터 디렉토리)
- name: Get PostgreSQL data directory
  shell: |
    # 방법 1: pg_lsclusters 사용 (Ubuntu/Debian) - 가장 정확한 방법
    if command -v pg_lsclusters &> /dev/null; then
      pg_lsclusters | awk 'NR>1 && $4=="online" {print $6; exit}'
    # 방법 2: Ubuntu/Debian 기본 경로에서 main 디렉토리 찾기
    elif [ -d "/var/lib/postgresql" ]; then
      find /var/lib/postgresql -maxdepth 2 -type d -name "main" 2>/dev/null | head -1
    # 방법 3: psql로 직접 확인 (실패할 수 있음)
    elif psql -U postgres -t -c "SHOW data_directory;" 2>/dev/null | head -1 | xargs; then
      psql -U postgres -t -c "SHOW data_directory;" 2>/dev/null | head -1 | xargs
    # 기본값
    else
      echo "/var/lib/postgresql"
    fi
  register: pg_data_directory
  ignore_errors: yes
  changed_when: false

- name: Check DB engine filesystem usage (data directory)
  shell: |
    # pg_data_directory에서 첫 번째 줄만 추출
    DATADIR_RAW="{{ pg_data_directory.stdout | default('/var/lib/postgresql') | trim }}"
    DATADIR=$(echo "$DATADIR_RAW" | head -1 | xargs)
    # DATADIR이 비어있거나 잘못된 경우 다시 찾기
    if [ -z "$DATADIR" ] || [ "$DATADIR" = "" ] || [[ "$DATADIR" == *"pg_lsclusters"* ]] || [[ "$DATADIR" == *"/usr/bin"* ]]; then
      if command -v pg_lsclusters &> /dev/null; then
        DATADIR=$(pg_lsclusters 2>/dev/null | awk 'NR>1 && $4=="online" {print $6; exit}')
      elif [ -d "/var/lib/postgresql" ]; then
        DATADIR=$(find /var/lib/postgresql -maxdepth 2 -type d -name "main" 2>/dev/null | head -1)
      else
        DATADIR="/var/lib/postgresql"
      fi
    fi
    if [ -n "$DATADIR" ] && [ "$DATADIR" != "" ] && [ -d "$DATADIR" ]; then
      df -h "$DATADIR" | tail -1
    elif [ -n "$DATADIR" ] && [ "$DATADIR" != "" ]; then
      PARENT_DIR=$(dirname "$DATADIR")
      if [ -d "$PARENT_DIR" ]; then
        df -h "$PARENT_DIR" | tail -1
      else
        echo "Data directory not accessible: $DATADIR"
      fi
    else
      echo "Data directory not found"
    fi
  register: db_engine_fs
  failed_when: false
  changed_when: false

# 1-2. 아카이브(데이터변경) 로그 파일시스템 (WAL 아카이브 디렉토리)
- name: Get PostgreSQL archive_command or archive directory
  shell: |
    ARCHIVE_MODE=$(psql -U postgres -t -c "SHOW archive_mode;" 2>/dev/null | xargs || sudo -n -u postgres psql -t -c "SHOW archive_mode;" | xargs)
    if [ "$ARCHIVE_MODE" = "on" ]; then
      ARCHIVE_CMD=$(psql -U postgres -t -c "SHOW archive_command;" 2>/dev/null | xargs || sudo -n -u postgres psql -t -c "SHOW archive_command;" | xargs)
      echo "$ARCHIVE_CMD" | grep -oP "(?<=/)[^']+/" | head -1 || echo "/var/lib/pgsql/archive"
    else
      echo "/var/lib/pgsql/archive"
    fi
  register: pg_archive_path
  ignore_errors: yes
  changed_when: false

- name: Check archive log filesystem usage
  shell: |
    ARCHIVE_PATH="{{ pg_archive_path.stdout | default('/var/lib/pgsql/archive') | trim }}"
    if [ -d "$ARCHIVE_PATH" ]; then
      df -h "$ARCHIVE_PATH" | tail -1
    else
      # WAL 디렉토리 사용 (아카이브가 설정되지 않은 경우)
      WAL_DIR="/var/lib/pgsql/data/pg_wal"
      if [ -d "$WAL_DIR" ]; then
        df -h "$WAL_DIR" | tail -1
      else
        echo "Archive/WAL directory not found"
      fi
    fi
  register: archive_log_fs
  failed_when: false
  changed_when: false

# 1-3. DB 시스템 로그 파일시스템 (로그 디렉토리)
- name: Get PostgreSQL log directory
  shell: |
    LOG_DIRECTORY=$(sudo -u postgres psql -t -c "SHOW log_directory;" | xargs)
    DATA_DIR=$(sudo -u postgres psql -t -c "SHOW data_directory;" | xargs)
    if [ "$LOG_DIRECTORY" = "log" ] || [ -z "$LOG_DIRECTORY" ]; then
      echo "${DATA_DIR}/log"
    else
      echo "$LOG_DIRECTORY"
    fi
  register: pg_log_directory
  ignore_errors: yes
  changed_when: false

- name: Check system log filesystem usage
  shell: |
    LOG_DIR="{{ pg_log_directory.stdout | default('/var/lib/pgsql/data/log') | trim }}"
    if [ -d "$LOG_DIR" ]; then
      df -h "$LOG_DIR" | tail -1
    else
      # 기본 로그 위치 확인
      DATA_DIR=$(sudo -u postgres psql -t -c "SHOW data_directory;" | xargs)
      df -h "$DATA_DIR" | tail -1
    fi
  register: system_log_fs
  failed_when: false
  changed_when: false

# 1-4. 파일시스템 사용률 70% 초과 (기존)
- name: Check filesystem usage over 70%
  shell: df -hP | awk '$5+0 > 70 {print}'
  register: fs_usage
  failed_when: false
  changed_when: false

################################
# 2. PostgreSQL 서비스 상태
################################
- name: Check PostgreSQL service status
  systemd:
    name: postgresql
  register: pg_service

################################
# 3. PostgreSQL 리스너 (5432)
################################
- name: Check PostgreSQL listener (5432)
  shell: ss -lntp | grep 5432 || echo "5432 NOT LISTENING"
  register: pg_listener

################################
# 4. 프로세스 기동 상태 및 DB 접속 상태
################################
# 4-1. 메인(관리) 프로세스 기동 상태 (서비스 상태로 확인)
# (이미 #2에서 pg_service로 확인됨)

# 4-2. 리스너(DB서비스 연결) 프로세스 기동 상태
# (이미 #3에서 pg_listener로 확인됨)

# 4-3. DB 접속 상태 점검
- name: Check active DB sessions
  shell: |
    sudo -u postgres psql -t -c "
    SELECT datname,
           usename,
           client_addr,
           client_port,
           application_name
    FROM pg_stat_activity;"
  register: pg_sessions
  failed_when: false
  changed_when: false

- name: Check DB connection status
  shell: |
    CONN_COUNT=$(sudo -u postgres psql -t -c "SELECT count(*) FROM pg_stat_activity;" | xargs)
    if [ "$CONN_COUNT" -gt 0 ]; then
      echo "CONNECTED (${CONN_COUNT} sessions)"
    else
      echo "NO_CONNECTIONS"
    fi
  register: db_connection_status
  failed_when: false
  changed_when: false

################################
# 5. OS 리소스 사용률
################################
# 5-1. 물리적 메모리 사용률 (상세 정보)
- name: Check memory usage
  shell: free -h
  register: mem_usage
  changed_when: false

# 5-2. 물리적 메모리 사용률 (퍼센트)
- name: Calculate memory usage percentage
  shell: |
    MEM_INFO=$(free | grep Mem)
    TOTAL=$(echo $MEM_INFO | awk '{print $2}')
    USED=$(echo $MEM_INFO | awk '{print $3}')
    PERCENT=$(awk "BEGIN {printf \"%.2f\", ($USED/$TOTAL)*100}")
    echo "${PERCENT}%"
  register: mem_usage_percent
  changed_when: false
  failed_when: false

# 5-3. 물리적 CPU 사용률 (상세 정보)
- name: Check CPU usage
  shell: top -bn1 | grep "Cpu(s)"
  register: cpu_usage
  changed_when: false

# 5-4. 물리적 CPU 사용률 (퍼센트)
- name: Get CPU usage percentage
  shell: |
    top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}'
  register: cpu_usage_percent
  changed_when: false
  failed_when: false

# 5-5. 프로세스 개수
- name: Check OS process count
  shell: ps -ef | wc -l
  register: process_count
  changed_when: false

################################
# 6. PostgreSQL 파라미터 점검
################################
- name: Check shared_buffers
  shell: sudo -u postgres psql -t -c "SELECT current_setting('shared_buffers');"
  register: shared_buffers
  ignore_errors: yes
  failed_when: false

- name: Check max_connections
  shell: sudo -u postgres psql -t -c "SELECT current_setting('max_connections');"
  register: max_connections
  ignore_errors: yes
  failed_when: false

################################
# 7. 테이블스페이스 사용률
################################
- name: Check tablespace usage
  shell: |
    sudo -u postgres psql -t -c "
    SELECT spcname,
           pg_size_pretty(pg_tablespace_size(spcname))
    FROM pg_tablespace;"
  register: tablespace
  ignore_errors: yes
  failed_when: false

################################
# 8. WAL (트랜잭션 로그) 점검
################################
# 8-1. 아카이브 모드 확인 (온라인 백업 가능 여부)
- name: Check archive_mode
  shell: sudo -u postgres psql -t -c "SHOW archive_mode;"
  register: archive_mode
  changed_when: false
  failed_when: false

# 8-2. 온라인 백업 가능 여부 확인
- name: Check if online backup is possible
  shell: |
    ARCHIVE_MODE=$(sudo -u postgres psql -t -c "SHOW archive_mode;" | xargs)
    WAL_LEVEL=$(sudo -u postgres psql -t -c "SHOW wal_level;" | xargs)
    if [ "$ARCHIVE_MODE" = "on" ] && [ "$WAL_LEVEL" != "minimal" ]; then
      echo "ONLINE_BACKUP_POSSIBLE"
    else
      echo "ONLINE_BACKUP_NOT_POSSIBLE (archive_mode: ${ARCHIVE_MODE}, wal_level: ${WAL_LEVEL})"
    fi
  register: online_backup_possible
  ignore_errors: yes
  changed_when: false

# 8-3. 트랜잭션 로그 사이즈 (WAL 디렉토리 크기)
- name: Get PostgreSQL data directory for WAL
  shell: sudo -u postgres psql -t -c "SHOW data_directory;"
  register: pg_wal_data_dir
  ignore_errors: yes
  changed_when: false

- name: Check WAL directory size
  shell: |
    DATA_DIR="{{ pg_wal_data_dir.stdout | default('/var/lib/pgsql/data') | trim }}"
    WAL_DIR="${DATA_DIR}/pg_wal"
    if [ -d "$WAL_DIR" ]; then
      # WAL 파일들의 총 크기 계산
      TOTAL_SIZE=$(du -sb "$WAL_DIR" 2>/dev/null | awk '{print $1}')
      if [ -n "$TOTAL_SIZE" ] && [ "$TOTAL_SIZE" -gt 0 ]; then
        # 바이트를 읽기 쉬운 형식으로 변환
        if [ "$TOTAL_SIZE" -lt 1024 ]; then
          echo "${TOTAL_SIZE}B"
        elif [ "$TOTAL_SIZE" -lt 1048576 ]; then
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1024}")KB"
        elif [ "$TOTAL_SIZE" -lt 1073741824 ]; then
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1048576}")MB"
        else
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1073741824}")GB"
        fi
      else
        echo "0 (WAL directory empty or not accessible)"
      fi
    else
      echo "WAL directory not found: $WAL_DIR"
    fi
  register: wal_size
  ignore_errors: yes
  changed_when: false

################################
# 9. 설치 확인 및 경로 점검
################################
# 9-1. PostgreSQL 설치 확인
- name: Check PostgreSQL installation
  shell: |
    if command -v psql &> /dev/null; then
      echo "INSTALLED"
    else
      echo "NOT_INSTALLED"
    fi
  register: pg_installation
  changed_when: false
  failed_when: false

# 9-2. PostgreSQL 설치 경로 확인
- name: Get PostgreSQL binary path
  shell: |
    which psql || echo "N/A"
  register: pg_binary_path
  changed_when: false
  failed_when: false

# 9-3. PostgreSQL 데이터 디렉토리 경로 (설치 경로로 사용)
- name: Get PostgreSQL base directory
  shell: |
    # pg_data_directory에서 첫 번째 줄만 추출
    DATADIR_RAW="{{ pg_data_directory.stdout | default('') | trim }}"
    DATADIR=$(echo "$DATADIR_RAW" | head -1 | xargs)
    # DATADIR이 비어있거나 잘못된 경우 다시 찾기
    if [ -z "$DATADIR" ] || [ "$DATADIR" = "" ] || [[ "$DATADIR" == *"pg_lsclusters"* ]] || [[ "$DATADIR" == *"/usr/bin"* ]]; then
      if command -v pg_lsclusters &> /dev/null; then
        DATADIR=$(pg_lsclusters 2>/dev/null | awk 'NR>1 && $4=="online" {print $6; exit}')
      elif [ -d "/var/lib/postgresql" ]; then
        DATADIR=$(find /var/lib/postgresql -maxdepth 2 -type d -name "main" 2>/dev/null | head -1)
      else
        DATADIR="/var/lib/postgresql"
      fi
    fi
    # DATADIR이 유효한 경로인지 확인하고 부모 디렉토리 반환
    if [ -n "$DATADIR" ] && [ "$DATADIR" != "" ] && [ "$DATADIR" != "/" ] && [[ ! "$DATADIR" == *"pg_lsclusters"* ]] && [[ ! "$DATADIR" == *"/usr/bin"* ]]; then
      BASEDIR=$(dirname "$DATADIR")
      # main 디렉토리인 경우 한 단계 더 위로
      if [ "$(basename "$DATADIR")" = "main" ]; then
        BASEDIR=$(dirname "$BASEDIR")
      fi
      echo "$BASEDIR"
    else
      echo "/var/lib/postgresql"
    fi
  register: pg_base_dir
  ignore_errors: yes
  changed_when: false

################################
# 10. 데이터베이스 정보 점검
################################
# 10-1. 데이터베이스 목록
- name: Get database list
  shell: |
    sudo -u postgres psql -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" | xargs -n1 | grep -v postgres || echo ""
  register: db_list
  ignore_errors: yes
  changed_when: false

# 10-2. 데이터베이스 개수
- name: Get database count
  shell: |
    sudo -u postgres psql -t -c "SELECT count(*) FROM pg_database WHERE datistemplate = false;" | xargs
  register: db_count
  ignore_errors: yes
  changed_when: false

################################
# 11. CPU/메모리 상위 프로세스 점검
################################
# 11-1. CPU 사용률 상위 프로세스 (상위 5개)
- name: Get top CPU processes
  shell: |
    ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $3, $12}'
  register: cpu_top_processes
  changed_when: false
  failed_when: false

# 11-2. 메모리 사용률 상위 프로세스 (상위 5개)
- name: Get top memory processes
  shell: |
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $4, $12}'
  register: mem_top_processes
  changed_when: false
  failed_when: false

################################
# 12. OS 기초 체력 점검 (DB 서버 운영에 필수적인 항목)
################################
# 12-1. CPU 모델명 확인
# 중요성: DB 서버 하드웨어 스펙 확인, 성능 분석 및 용량 계획에 필요
- name: Get CPU model name
  shell: |
    lscpu | grep "Model name" | awk -F: '{print $2}' | xargs
  register: cpu_model_name
  changed_when: false
  failed_when: false

# 12-2. 메모리(Swap) 상태 점검
# 중요성: DB 서버에서 Swap 사용은 성능 저하 신호. 메모리 부족 시 Swap 사용되면 쿼리 성능 급격히 저하
- name: Check Swap status
  shell: free -h | grep Swap
  register: swap_status
  changed_when: false
  failed_when: false

# 12-3. 디스크(/) 사용률 점검
# 중요성: 루트 디스크가 가득 차면 시스템 로그, 임시 파일 생성 불가로 DB 서비스 장애 가능
- name: Check root disk usage
  shell: df -h / | awk 'NR==2 {print $5}' | tr -d '%'
  register: root_disk_usage
  changed_when: false
  failed_when: false

# 12-4. 전체 디스크 사용 현황
# 중요성: DB 데이터 디렉토리 외 다른 디스크 사용률 확인. 전체 디스크 상황 파악 필요
- name: Check all disk usage
  shell: df -h
  register: all_disk_usage
  changed_when: false
  failed_when: false

# 12-5. 외부 네트워크(Google) 통신 점검
# 중요성: DB 백업, 복제, 모니터링, 패키지 업데이트 등에 외부 네트워크 연결 필요
- name: Test external network connectivity
  shell: ping -c 2 8.8.8.8
  register: network_ping_result
  changed_when: false
  failed_when: false
  ignore_errors: yes

# 12-6. 시간 동기화(NTP) 점검
# 중요성: DB 서버 시간 불일치는 트랜잭션 로그 순서, 복제 동기화, 백업 일관성에 심각한 문제 발생
- name: Check NTP synchronization
  shell: chronyc sources -v 2>/dev/null || echo "NTP not configured"
  register: ntp_sync_status
  changed_when: false
  failed_when: false
  ignore_errors: yes

################################
# 13. 보고서 생성
################################
- name: Generate PostgreSQL check report
  template:
    src: report.j2
    dest: /tmp/postgresql_check_report.txt

