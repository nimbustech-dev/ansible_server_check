---
################################
# 1. OS 파일시스템 사용률 점검
################################
# 1-1. DB엔진 파일시스템 (데이터 디렉토리)
- name: Get PostgreSQL data directory
  shell: sudo -u postgres psql --connect-timeout=5 -t -c "SHOW data_directory;"
  register: pg_data_directory
  ignore_errors: yes
  changed_when: false

- name: Check DB engine filesystem usage (data directory)
  shell: |
    DATADIR="{{ pg_data_directory.stdout | default('/var/lib/pgsql/data') | trim }}"
    df -h "$DATADIR" | tail -1
  register: db_engine_fs
  failed_when: false
  changed_when: false

# 1-2. 아카이브(데이터변경) 로그 파일시스템 (WAL 아카이브 디렉토리)
- name: Get PostgreSQL archive_command or archive directory
  shell: |
    ARCHIVE_MODE=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW archive_mode;" | xargs)
    if [ "$ARCHIVE_MODE" = "on" ]; then
      ARCHIVE_CMD=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW archive_command;" | xargs)
      # archive_command에서 디렉토리 추출 시도
      echo "$ARCHIVE_CMD" | grep -oP "(?<=/)[^']+/" | head -1 || echo "/var/lib/pgsql/archive"
    else
      echo "/var/lib/pgsql/archive"
    fi
  register: pg_archive_path
  ignore_errors: yes
  changed_when: false

- name: Check archive log filesystem usage
  shell: |
    ARCHIVE_PATH="{{ pg_archive_path.stdout | default('/var/lib/pgsql/archive') | trim }}"
    if [ -d "$ARCHIVE_PATH" ]; then
      df -h "$ARCHIVE_PATH" | tail -1
    else
      # WAL 디렉토리 사용 (아카이브가 설정되지 않은 경우)
      WAL_DIR="/var/lib/pgsql/data/pg_wal"
      if [ -d "$WAL_DIR" ]; then
        df -h "$WAL_DIR" | tail -1
      else
        echo "Archive/WAL directory not found"
      fi
    fi
  register: archive_log_fs
  failed_when: false
  changed_when: false

# 1-3. DB 시스템 로그 파일시스템 (로그 디렉토리)
- name: Get PostgreSQL log directory
  shell: |
    LOG_DIRECTORY=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW log_directory;" | xargs)
    DATA_DIR=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW data_directory;" | xargs)
    if [ "$LOG_DIRECTORY" = "log" ] || [ -z "$LOG_DIRECTORY" ]; then
      echo "${DATA_DIR}/log"
    else
      echo "$LOG_DIRECTORY"
    fi
  register: pg_log_directory
  ignore_errors: yes
  changed_when: false

- name: Check system log filesystem usage
  shell: |
    LOG_DIR="{{ pg_log_directory.stdout | default('/var/lib/pgsql/data/log') | trim }}"
    if [ -d "$LOG_DIR" ]; then
      df -h "$LOG_DIR" | tail -1
    else
      # 기본 로그 위치 확인
      DATA_DIR=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW data_directory;" | xargs)
      df -h "$DATA_DIR" | tail -1
    fi
  register: system_log_fs
  failed_when: false
  changed_when: false

# 1-4. 파일시스템 사용률 70% 초과 (기존)
- name: Check filesystem usage over 70%
  shell: df -hP | awk '$5+0 > 70 {print}'
  register: fs_usage
  failed_when: false
  changed_when: false

################################
# 2. PostgreSQL 서비스 상태
################################
- name: Check PostgreSQL service status
  systemd:
    name: postgresql
  register: pg_service

################################
# 3. PostgreSQL 리스너 (5432)
################################
- name: Check PostgreSQL listener (5432)
  shell: ss -lntp | grep 5432 || echo "5432 NOT LISTENING"
  register: pg_listener

################################
# 4. 프로세스 기동 상태 및 DB 접속 상태
################################
# 4-1. 메인(관리) 프로세스 기동 상태 (서비스 상태로 확인)
# (이미 #2에서 pg_service로 확인됨)

# 4-2. 리스너(DB서비스 연결) 프로세스 기동 상태
# (이미 #3에서 pg_listener로 확인됨)

# 4-3. DB 접속 상태 점검
- name: Check active DB sessions
  shell: |
    sudo -u postgres psql --connect-timeout=5 -t -c "
    SELECT datname,
           usename,
           client_addr,
           client_port,
           application_name
    FROM pg_stat_activity;"
  register: pg_sessions
  failed_when: false
  changed_when: false

- name: Check DB connection status
  shell: |
    CONN_COUNT=$(sudo -u postgres psql --connect-timeout=5 -t -c "SELECT count(*) FROM pg_stat_activity;" | xargs)
    if [ "$CONN_COUNT" -gt 0 ]; then
      echo "CONNECTED (${CONN_COUNT} sessions)"
    else
      echo "NO_CONNECTIONS"
    fi
  register: db_connection_status
  failed_when: false
  changed_when: false

################################
# 5. OS 리소스 사용률
################################
# 5-1. 물리적 메모리 사용률 (상세 정보)
- name: Check memory usage
  shell: free -h
  register: mem_usage
  changed_when: false

# 5-2. 물리적 메모리 사용률 (퍼센트)
- name: Calculate memory usage percentage
  shell: |
    MEM_INFO=$(free | grep Mem)
    TOTAL=$(echo $MEM_INFO | awk '{print $2}')
    USED=$(echo $MEM_INFO | awk '{print $3}')
    PERCENT=$(awk "BEGIN {printf \"%.2f\", ($USED/$TOTAL)*100}")
    echo "${PERCENT}%"
  register: mem_usage_percent
  changed_when: false
  failed_when: false

# 5-3. 물리적 CPU 사용률 (상세 정보)
- name: Check CPU usage
  shell: top -bn1 | grep "Cpu(s)"
  register: cpu_usage
  changed_when: false

# 5-4. 물리적 CPU 사용률 (퍼센트)
- name: Get CPU usage percentage
  shell: |
    top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}'
  register: cpu_usage_percent
  changed_when: false
  failed_when: false

# 5-5. 프로세스 개수
- name: Check OS process count
  shell: ps -ef | wc -l
  register: process_count
  changed_when: false

################################
# 6. PostgreSQL 파라미터 점검
################################
- name: Check shared_buffers
  shell: sudo -u postgres psql --connect-timeout=5 -t -c "SELECT current_setting('shared_buffers');"
  register: shared_buffers

- name: Check max_connections
  shell: sudo -u postgres psql --connect-timeout=5 -t -c "SELECT current_setting('max_connections');"
  register: max_connections

################################
# 7. 테이블스페이스 사용률
################################
- name: Check tablespace usage
  shell: |
    sudo -u postgres psql --connect-timeout=5 -t -c "
    SELECT spcname,
           pg_size_pretty(pg_tablespace_size(spcname))
    FROM pg_tablespace;"
  register: tablespace

################################
# 8. WAL (트랜잭션 로그) 점검
################################
# 8-1. 아카이브 모드 확인 (온라인 백업 가능 여부)
- name: Check archive_mode
  shell: sudo -u postgres psql --connect-timeout=5 -t -c "SHOW archive_mode;"
  register: archive_mode
  changed_when: false
  failed_when: false

# 8-2. 온라인 백업 가능 여부 확인
- name: Check if online backup is possible
  shell: |
    ARCHIVE_MODE=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW archive_mode;" | xargs)
    WAL_LEVEL=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW wal_level;" | xargs)
    if [ "$ARCHIVE_MODE" = "on" ] && [ "$WAL_LEVEL" != "minimal" ]; then
      echo "ONLINE_BACKUP_POSSIBLE"
    else
      echo "ONLINE_BACKUP_NOT_POSSIBLE (archive_mode: ${ARCHIVE_MODE}, wal_level: ${WAL_LEVEL})"
    fi
  register: online_backup_possible
  ignore_errors: yes
  changed_when: false

# 8-3. 트랜잭션 로그 사이즈 (WAL 디렉토리 크기)
- name: Get PostgreSQL data directory for WAL
  shell: sudo -u postgres psql --connect-timeout=5 -t -c "SHOW data_directory;"
  register: pg_wal_data_dir
  ignore_errors: yes
  changed_when: false

- name: Check WAL directory size
  shell: |
    DATA_DIR="{{ pg_wal_data_dir.stdout | default('/var/lib/pgsql/data') | trim }}"
    WAL_DIR="${DATA_DIR}/pg_wal"
    if [ -d "$WAL_DIR" ]; then
      # WAL 파일들의 총 크기 계산
      TOTAL_SIZE=$(du -sb "$WAL_DIR" 2>/dev/null | awk '{print $1}')
      if [ -n "$TOTAL_SIZE" ] && [ "$TOTAL_SIZE" -gt 0 ]; then
        # 바이트를 읽기 쉬운 형식으로 변환
        if [ "$TOTAL_SIZE" -lt 1024 ]; then
          echo "${TOTAL_SIZE}B"
        elif [ "$TOTAL_SIZE" -lt 1048576 ]; then
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1024}")KB"
        elif [ "$TOTAL_SIZE" -lt 1073741824 ]; then
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1048576}")MB"
        else
          echo "$(awk "BEGIN {printf \"%.2f\", $TOTAL_SIZE/1073741824}")GB"
        fi
      else
        echo "0 (WAL directory empty or not accessible)"
      fi
    else
      echo "WAL directory not found: $WAL_DIR"
    fi
  register: wal_size
  ignore_errors: yes
  changed_when: false

################################
# 9. 설치 확인 및 경로 점검
################################
# 9-1. PostgreSQL 설치 확인
- name: Check PostgreSQL installation
  shell: |
    if command -v psql &> /dev/null; then
      echo "INSTALLED"
    else
      echo "NOT_INSTALLED"
    fi
  register: pg_installation
  changed_when: false
  failed_when: false

# 9-2. PostgreSQL 설치 경로 확인
- name: Get PostgreSQL binary path
  shell: |
    which psql || echo "N/A"
  register: pg_binary_path
  changed_when: false
  failed_when: false

# 9-3. PostgreSQL 데이터 디렉토리 경로 (설치 경로로 사용)
- name: Get PostgreSQL base directory
  shell: |
    DATADIR=$(sudo -u postgres psql --connect-timeout=5 -t -c "SHOW data_directory;" 2>/dev/null | xargs || echo "/var/lib/pgsql/data")
    BASEDIR=$(dirname "$DATADIR")
    echo "$BASEDIR"
  register: pg_base_dir
  ignore_errors: yes
  changed_when: false

################################
# 10. 데이터베이스 정보 점검
################################
# 10-1. 데이터베이스 목록
- name: Get database list
  shell: |
    sudo -u postgres psql --connect-timeout=5 -t -c "SELECT datname FROM pg_database WHERE datistemplate = false;" | xargs -n1 | grep -v postgres || echo ""
  register: db_list
  ignore_errors: yes
  changed_when: false

# 10-2. 데이터베이스 개수
- name: Get database count
  shell: |
    sudo -u postgres psql --connect-timeout=5 -t -c "SELECT count(*) FROM pg_database WHERE datistemplate = false;" | xargs
  register: db_count
  ignore_errors: yes
  changed_when: false

################################
# 11. CPU/메모리 상위 프로세스 점검
################################
# 11-1. CPU 사용률 상위 프로세스 (상위 5개)
- name: Get top CPU processes
  shell: |
    ps aux --sort=-%cpu | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $3, $12}'
  register: cpu_top_processes
  changed_when: false
  failed_when: false

# 11-2. 메모리 사용률 상위 프로세스 (상위 5개)
- name: Get top memory processes
  shell: |
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{printf "%-10s %6s%% %s\n", $11, $4, $12}'
  register: mem_top_processes
  changed_when: false
  failed_when: false

################################
# 12. 보고서 생성
################################
- name: Generate PostgreSQL check report
  template:
    src: report.j2
    dest: /tmp/postgresql_check_report.txt

